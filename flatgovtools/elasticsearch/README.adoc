### Using Elasticsearch for Similarity and Search

We use Elasticsearch (&#x2265; v7.9.2)
to index bills. With the index, we can calculate similarity between documents or parts of documents using https://www.elastic.co/guide/en/elasticsearch/reference/current/similarity.html[built-in] or https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-similarity.html#_available_similarities[custom] similarity metrics, and provide for full-text search in the app.

#### Install Elasticsearch 

See https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-install.html

For MacOS, for example:

* Install

```bash
$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.9.2-darwin-x86_64.tar.gz
$ tar -xvf elasticsearch-7.9.2-darwin-x86_64.tar.gz
```

* Run

```bash
$ cd elasticsearch-7.9.2/bin
$ ./elasticsearch
```

#### Indexing with Python

See, e.g., https://kb.objectrocket.com/elasticsearch/use-python-to-index-files-into-elasticsearch-index-all-files-in-a-directory-part-2-852

The functions in `scripts/elastic_load.py` load a bill file into the Elasticsearch index and provide a sample query. XML files are loaded with `nested` indexing and `nested` query, to account for the hierarchical levels. Initially, we are indexing only at the section level, as follows:

```python
{
    'headers': list(OrderedDict.fromkeys(headers_text)),
     'sections': [{
     'section_number': section.find('enum').text,
     'section_text': etree.tostring(section, method="text", encoding="unicode"),
     'section_xml': etree.tostring(section, method="xml", encoding="unicode"),
     'section_header':  section.find('header').text
     ]
     }
```

Once a bill is converted into the form above, it is indexed. Both as a whole document, and with the sections indexed separatetly (as 'nested' documents).

NOTE: When an inner mapping field is set with a 'similarity' key   (e.g. ``"section_text": {"type": "text", "similarity": "classic"}`), it appears to break the nesting; the nested query no longer works and an Exception is thrown, indicating that 'sections' is not a nested field.

### Backup and restore with elasticdump

* Install `elasticdump` command-line application with npm

`npm install -g elasticdump`

* Store `billsections` index to a .gz file

`elasticdump --input=http://localhost:9200/billsections --output=$   | gzip > ./elasticdump.billsections.json.gz`

* Import data from `.json`

** Unzip the `.json.gz`

`gzip -d elasticdump.billsections.json.gz` 

** Restore data to Elasticsearch

```
# Import data from .json into ES
elasticdump \
  --input "${file_name}.json" \
  --output=http://localhost:9200/billsections
```

Or import from S3

```
# Import data from S3 into ES (using s3urls) 
elasticdump \
  --s3AccessKeyId "${access_key_id}" \
  --s3SecretAccessKey "${access_key_secret}" \
  --input "s3://${bucket_name}/${file_name}.json" \
  --output=http://localhost:9200/billsections
```

### Install Logstash

NOTE: we are not using Logstash to index; the logstash-filter.conf we built in the `elasticsearch` directory does not (yet) work.

For MacOs, for example:

* Install

```bash
$ curl -L -O https://artifacts.elastic.co/downloads/logstash/logstash-7.9.2.tar.gz
$ tar -xvf logstash-7.9.2.tar.gz
```

* Set up a logstash config file

See https://www.elastic.co/guide/en/logstash/current/configuration.html


### Bill Similarity metrics
1. Of all of the bills, the bill should be most similar to itself. So if we do search for similar bills, the same bill should come up. But now, it doesn't.

For example: I am not seeing that `116hr300` is in the similar bills list for `116hr300`.
The issue occurs due to `moreLikeThis` function.

We need to update elastic search query `moreLikeThis` function is using.
